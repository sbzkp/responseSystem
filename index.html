<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proxy</title>
    <style>
        #container{
            width: 100px;
            height: 100px;
            border: 1px solid skyblue;
        }
    </style>
</head>
<body>
    <div id="container"></div>
</body>
</html>
<script>
    let bucket = new WeakMap();
    let activeFn;
    let effectStack = [];
    let registerEffect = ( fn )=>{
        effectStack.push( fn )
        fn();
        effectStack.pop(  )
    }
  
    let data = { text: "hello world", outerText: "初始值" };
    const proxyData = new Proxy(data, {
        get( target, key ){
            let targetDataEffectList = bucket.get(target);
            if ( !targetDataEffectList ) {
                bucket.set( target, (targetDataEffectList = new Map()) )
            }
            let keyDataEffectList = targetDataEffectList.get(key);
            if (  !keyDataEffectList ) {
                targetDataEffectList.set( key, ( keyDataEffectList = new Set() ) );
            }
            let currentEffect = effectStack[effectStack.length-1];
            if (currentEffect) {
                keyDataEffectList.add( currentEffect );
            }

            return target[key];
        },
        set( target, key, newVal ){
            target[key] = newVal;
            let targetDataEffectList = bucket.get(target);
            if ( !targetDataEffectList ) {
                return;
            }
            if (targetDataEffectList) {
                let keyDataEffectList = targetDataEffectList.get(key) || new Set();
                    for (const effect of [...keyDataEffectList]) {
                    effect();
                }
            }
        }
    })

    let setDivInnerhtml = ()=>{
        console.log("内部副作用")
        document.getElementById("container").innerText = proxyData.text;
    }


    registerEffect( ()=>{
        console.log("外部副作用")
        registerEffect( setDivInnerhtml )
        let temp = proxyData.outerText;
    } )
    
    setTimeout(()=>{
        //本该触发外部副作用，却触发了内部副作用，原因是因为执行内部的时候，将activeFn的值覆盖掉了
        proxyData.outerText = " 你好，世界"
    },1000)
</script>